---
title: "SEGA: ERP-ET Analysis (ASD-CON-MHC)"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: true
    theme: cerulean
    code_folding: hide
editor_options:
  chunk_output_type: console
  pdf_document:
    toc: yes
---
```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# REQUIRED PACKAGES
require(performance) # marginal + conditional R2
require(lme4) # linear-mixed-effects models
require(lmerTest, warn.conflicts = FALSE) # linear-mixed-effects models
require(emmeans, warn.conflicts = FALSE) # estimated marginal means (EMMs)
require(ggplot2, warn.conflicts = FALSE) # creating graphs
require(dplyr, warn.conflicts = FALSE) # for %>% operator
library(ggpubr, warn.conflicts = FALSE) # ggscatter()-function
library(knitr) # dynamic report generation
library(kableExtra) # table formatting
library(stringr) # for string modifications
library(tidyverse)

# PATHS
if (Sys.info()["sysname"] == "Linux") {
  home_path <- "~"
  project_path <- "/PowerFolders/project_sega"
  data_path <- "/PowerFolders/project_sega/data/AuditoryOddball"
  data_path_eeg <- "/PowerFolders/project_sega/data/AuditoryOddball_EEG"
  datapath <- paste0(home_path, data_path) # .csv + .hdf5 input files
  datapath_eeg <- paste0(home_path, data_path_eeg) # .txt input files (eeg)
  # List all .hdf and .csv files
  data_files <- list.files(path = datapath, full.names = TRUE)
}

if (Sys.info()["sysname"] == "Windows") {
  home_path <- "C:/Users/Nico"
  project_path <- "/PowerFolders/project_sega"
  data_path <- "/PowerFolders/project_sega/data/et auditory oddball"
  data_path_task<-"/PowerFolders/project_sega/data/task auditory oddball"
  data_path_eeg <- "/PowerFolders/project_sega/data/tests/eeg preprocessed auditory oddball"
  datapath <- paste0(home_path, data_path) # hdf5 input files
  datapath_task <- paste0(home_path, data_path_task) # hdf5 input files
  datapath_eeg <- paste0(home_path, data_path_eeg) # .txt input files (eeg)
  # List all .hdf and .csv files
  data_files <- c(list.files(path = datapath, full.names = TRUE),
                  list.files(path = datapath_task, full.names = TRUE))
}

if (Sys.info()["sysname"] == "Darwin") {
  home_path <- "~"
  project_path <- "/code"
  data_path <- "/code/input/AuditoryOddball/eyetracking"
  data_path_task <- "/code/input/AuditoryOddball/taskdata"
  data_path_eeg <- "/code/input/AuditoryOddball/eeg"
  datapath <- paste0(home_path, data_path) # .hdf5 input files
  datapath_task <- paste0(home_path, data_path_task) # .csv input files
  datapath_eeg <- paste0(home_path, data_path_eeg) # .txt input files (eeg)
  data_path_single_trial_eeg <- "/code/input/AuditoryOddball/eeg_single_trial"
  datapath_single_eeg <- paste0(home_path, data_path_single_trial_eeg)
  # List all .hdf and .csv files
  data_files <- c(
    list.files(path = datapath, full.names = TRUE),
    list.files(path = datapath_task, full.names = TRUE))
}

# Can be used to skip preprocessing and directly read proprocessed data from .rds file:
et_erp_subject <- readRDS(paste0(home_path,project_path,'/data/preprocessed_auditory_ET_ERP_subject.rds')) # eeg + pupil (subject level, only oddball(rev) blocks)
et_erp_trial <- readRDS(paste0(home_path,project_path,'/data/preprocessed_auditory_ET_ERP_trial.rds')) # eeg + pupil(single-trial, only oddball(rev) blocks)

# changes random intercept to a factor
et_erp_subject$SEGA_ID <- as.factor(et_erp_subject$SEGA_ID)
et_erp_trial$SEGA_ID <- as.factor(et_erp_trial$SEGA_ID)

# changes covariates to a factor
et_erp_subject$gender <- as.factor(et_erp_subject$gender)
et_erp_trial$gender <- as.factor(et_erp_trial$gender)
```

# **Subject Level**
## Sample size
```{r, warning=FALSE}
length(unique(et_erp_subject$SEGA_ID))
table(et_erp_subject$group)/8
```

## Distributions of dependent variables
```{r, warning=FALSE}
hist(et_erp_subject$rpd,
     main = "Distribution of SEPR (500-1500 ms)",
     xlab = "SEPR (= rpd)",
     xlim = c(-0.1, 0.2),
     breaks = 200)

hist(et_erp_subject$rpd_low,
     main = "Distribution of BPS (0-250 ms)",
     xlab = "BPS (= rpd_low)",
     xlim = c(2, 5.5),
     breaks = 200)

hist(et_erp_subject$MMN_amplitude,
     main = "Distribution of MMN amplitude (100-150 ms)",
     xlab = "MMN amplitude (FC1, FC2, FCz, Fz)",
     ylim = c(0, 30),
     xlim = c(-15, 4.5),
     breaks = 200)

hist(et_erp_subject$P3a_amplitude,
     main = "Distribution of P3a amplitude (150-250 ms)",
     xlab = "P3a amplitude (Cz, FCz)",
     ylim = c(0, 30),
     xlim = c(-5, 10),
     breaks = 200)
hist(et_erp_subject$P3b_amplitude,
     main = "Distribution of P3a amplitude (250-500 ms)",
     xlab = "P3b amplitude (Pz)",
     ylim = c(0, 30),
     xlim = c(-10, 20),
     breaks = 200)
```

## Sample Characteristics
```{r, warning=FALSE}
exp_groups <- read.csv("exp_groups.csv", header = TRUE)
exp_groups$SEGA_ID <- as.factor(exp_groups$SEGA_ID)
exp_groups$group <- as.factor(exp_groups$group)

## FSK
fsk_import <- read.csv("FSK.csv", header = T, sep = ";", dec = ",", fill = T)
fsk <- fsk_import[c("ID_Studie", "FSK_ges")]
colnames(fsk)[colnames(fsk) == "ID_Studie"] <- "SEGA_ID" # same column name as in exp_groups for matching
fsk$SEGA_ID <- sub(".*SEGA_", "", fsk$SEGA_ID)
fsk$SEGA_ID <- str_replace(fsk$SEGA_ID, "^0+", "")
fsk$SEGA_ID <- as.factor(fsk$SEGA_ID)

## CBCL
cbcl_import <- read.csv("CBCL.csv", header = T, sep = ";", dec = ",", fill = T)
cbcl <- cbcl_import[c("ID_Studie", "CBCL_T_INT", "CBCL_T_EXT", "CBCL_T_GES")]
colnames(cbcl)[colnames(cbcl) == "ID_Studie"] <- "SEGA_ID" # same column name as in exp_groups for matching
cbcl$SEGA_ID <- sub(".*SEGA_", "", cbcl$SEGA_ID)
cbcl$SEGA_ID <- str_replace(cbcl$SEGA_ID, "^0+", "")
cbcl$SEGA_ID <- as.factor(cbcl$SEGA_ID)

## SRS
srs_import <- read.csv("SRS.csv", header = T, sep = ";", dec = ",", fill = T)
srs <- srs_import[c("ID_Studie", "Gesamtwert_N_k_RW")]
colnames(srs)[colnames(srs) == "ID_Studie"] <- "SEGA_ID" # same column name as in exp_groups for matching
### add questionnaire name to column names 
colnames(srs)[colnames(srs) == "Gesamtwert_N_k_RW"] <- "SRS_Gesamtwert_N_k_RW"
colnames(srs)[colnames(srs) == "Gesamt_TW_ASS"] <- "SRS_Gesamt_TW_ASS"
colnames(srs)[colnames(srs) == "Gesamt_TW_AB"] <- "SRS_Gesamt_TW_AB"
srs$SEGA_ID <- sub(".*SEGA_", "", srs$SEGA_ID)
srs$SEGA_ID <- str_replace(srs$SEGA_ID, "^0+", "")
srs$SEGA_ID <- as.factor(srs$SEGA_ID)

### Create df for sample characteristics
age_gender <- et_erp_subject[, c("gender", "age", "SEGA_ID")]
# Combine in one df: sample_characteristics
list_sample <- list(age_gender, exp_groups, fsk, cbcl, srs)
sample_characteristics <- list_sample %>% reduce(full_join, by = "SEGA_ID")
# et_erp_subjects brings 6 rows with identical age + gender per subject -> delete duplicates
sample_characteristics <- sample_characteristics[!duplicated(sample_characteristics), ]
# Only keep sample characteristics for subjects in ERP_ET data
sample_characteristics <- sample_characteristics[sample_characteristics$SEGA_ID %in% et_erp_subject$SEGA_ID, ]


fun_return_descriptives <- function(group){
  group_df <- sample_characteristics[sample_characteristics$group == group, ]
  n <- count(group_df)
  male <- length(which(group_df$gender == "mÃ¤nnlich"))
  female <- length(which(group_df$gender == "weiblich"))
  gender_f_m <- paste(female,"/",male)
  age_mean <- round(mean(group_df$age, na.rm = TRUE), digits = 1)
  age_sd <- round(sd(group_df$age, na.rm = TRUE), digits = 1)
  age <- paste(age_mean, "(",age_sd,")" )
  srs_mean <- round(mean(group_df$SRS_Gesamtwert_N_k_RW, na.rm = TRUE), digits = 1)
  srs_sd <- round(sd(group_df$SRS_Gesamtwert_N_k_RW, na.rm = TRUE), digits = 1)
  srs <- paste(srs_mean, "(",srs_sd,")")
  cbcl_mean <- round(mean(group_df$CBCL_T_GES, na.rm = TRUE), digits = 1)
  cbcl_sd <- round(sd(group_df$CBCL_T_GES, na.rm = TRUE), digits = 1)
  cbcl <- paste(cbcl_mean, "(",cbcl_sd,")")
  fsk_mean <- round(mean(group_df$FSK_ges, na.rm = TRUE), digits = 1)
  fsk_sd <- round(sd(group_df$FSK_ges, na.rm = TRUE), digits = 1)
  fsk <- paste(fsk_mean, "(", fsk_sd, ")")
  group_characteristics <- data.frame(n, gender_f_m, age, srs, cbcl, fsk)
  t(group_characteristics)
}
## Descriptive statistics
asd_characteristics <- fun_return_descriptives(group = "ASD")
colnames(asd_characteristics) <- "ASD"
con_characteristics <- fun_return_descriptives(group = "CON")
colnames(con_characteristics) <- "CON"
mhc_characteristics <- fun_return_descriptives(group = "MHC")
colnames(mhc_characteristics) <- "MHC"

fsk_anova <- aov(FSK_ges ~ group, data = sample_characteristics)  
fsk_anova_p <- summary(fsk_anova)[[1]][["Pr(>F)"]][[1]]
age_anova <- aov(age ~ group, data = sample_characteristics)
age_anova_p <- summary(age_anova)[[1]][["Pr(>F)"]][[1]]
age_anova_p <- round(age_anova_p, digits = 2)
cbcl_anova <- aov(CBCL_T_GES ~ group, data = sample_characteristics)
cbcl_anova_p <- summary(cbcl_anova)[[1]][["Pr(>F)"]][[1]]
srs_anova <- aov(SRS_Gesamtwert_N_k_RW ~ group, data = sample_characteristics)
srs_anova_p <- summary(srs_anova)[[1]][["Pr(>F)"]][[1]]
# don't know how to extract p-value from chi2-test -> inserted manually
gender_chi2 <- chisq.test(sample_characteristics$gender, sample_characteristics$group)
p_values <- c(NA, 0.005, age_anova_p, srs_anova_p, cbcl_anova_p, fsk_anova_p)

sample_table <- cbind(asd_characteristics, con_characteristics, mhc_characteristics, p_values)

sample_characteristics_table <- kable(sample_table, caption = "Sample characteristics", digits = 2) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>% kable_styling
sample_characteristics_table

boxplot_fsk <- boxplot(
  FSK_ges ~ group, data = sample_characteristics, main = "FSK")
stripchart(sample_characteristics$FSK_ges ~ sample_characteristics$group, vertical = TRUE, method = "jitter",
           pch = 19, add = TRUE, col = 1:length(levels(sample_characteristics$group)))

boxplot_srs <- boxplot(
  SRS_Gesamtwert_N_k_RW ~ group, data = sample_characteristics, main = "SRS")
stripchart(sample_characteristics$SRS_Gesamtwert_N_k_RW ~ sample_characteristics$group, vertical = TRUE, method = "jitter",
           pch = 19, add = TRUE, col = 1:length(levels(sample_characteristics$group)))

boxplot_cbcl <- boxplot(
  CBCL_T_GES ~ group, data = sample_characteristics, main = "CBCL")
stripchart(sample_characteristics$CBCL_T_GES ~ sample_characteristics$group, vertical = TRUE, method = "jitter",
           pch = 19, add = TRUE, col = 1:length(levels(sample_characteristics$group)))
```

## MMN Amplitude
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  scale(MMN_amplitude) ~ trial * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ trial), adjust = "tukey")
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation|block), adjust = "tukey")
emmeans(
  lmm, list(pairwise ~ block|manipulation), adjust = "tukey")
plot(emmeans(
  lmm, list(pairwise ~ manipulation|block), adjust = "tukey"))
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## MMN Latency
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  scale(MMN_latency) ~ trial * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: trial x manipulation x group
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ trial * manipulation|group), "pairwise")
emmip(lmm, ~ manipulation |group * trial)
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## P3a Amplitude
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3a_amplitude) ~ trial * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ trial ), adjust = "tukey")
```

### Post-hoc: trial x group
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ trial|group), "pairwise")
contrast(emmeans(lmm, ~ group|trial), "pairwise")
emmip(lmm, ~ trial|group)
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|block), "pairwise")
emmip(lmm, ~ manipulation|block)
```

### Post-hoc: trial x group x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ group * trial|block), "pairwise")
emmip(lmm, ~ trial|group * block)
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## P3a Latency
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3a_latency) ~ trial * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ trial), adjust = "tukey")
```

### Post-hoc: manipulation
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

## P3b Amplitude
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3b_amplitude) ~ trial * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

#### Post-hoc: trial
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ trial), adjust = "tukey")
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## P3b Latency
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3b_latency) ~ trial * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

#### Post-hoc: trial
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ trial), adjust = "tukey")
```

#### Post-hoc: trial x group
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group|trial), adjust = "tukey")
emmip(lmm, ~ group | trial)
```

#### Post_hoc: trial x manipulation x group
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group|trial * manipulation), adjust = "tukey")
emmip(lmm, ~ group | trial * manipulation)
```

#### post-hoc: trial x manipulation x block
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation|trial * block), adjust = "tukey")
emmip(lmm, ~ manipulation| trial * block)
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## SEPR
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  scale(rpd) ~ trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ trial), adjust = "tukey")
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## BPS
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  scale(rpd_low) ~ trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_subject)
anova(lmm) 
r2_nakagawa(lmm) 
```

### Post-hoc: manipulation
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## Post-hoc: manipulation x group
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation|group), adjust = "tukey")
emmip(lmm, ~ manipulation | group, CIs = T)
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation|block), adjust = "tukey")
emmip(lmm, ~ manipulation | block)
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

## Association between pupil data and ERPs
```{r, warning=FALSE}
crl <- cor(et_erp_subject[et_erp_subject$trial == "Oddball", c(
  "z_rpd_low",
  "z_rpd",
  "z_MMN_amplitude",
  "z_P3a_amplitude"
)],
use="complete.obs")
crl
corrplot::corrplot(
  crl,
  method = "circle",
  title = "Association between pupil data and ERPs in oddball trials",
  mar=c(0,0,1,0))

crl <- cor(et_erp_subject[et_erp_subject$trial == "Standard", c(
  "z_rpd_low",
  "z_rpd",
  "z_MMN_amplitude",
  "z_P3a_amplitude"
)],
use="complete.obs")
crl
corrplot::corrplot(
  crl,
  method = "circle",
  title = "Association between pupil data and ERPs in standard trials",
  mar=c(0,0,1,0))
```

## Does pupil data predict ERPs?
### Does SEPR/BPS predict MMN amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  scale(MMN_amplitude) ~ rpd * rpd_low * trial *  manipulation * group + (1|SEGA_ID),
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### Does SEPR/BPS predict P3a amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3a_amplitude) ~ rpd * rpd_low * trial *  manipulation * group + (1|SEGA_ID),
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### Does SEPR/BPS predict P3b amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3b_amplitude) ~ rpd * rpd_low * trial *  manipulation * group + (1|SEGA_ID),
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

## Exploratory: Grip strength (z-values)
### MMN Amplitude
```{r, warning=FALSE}
lmm <- lmer(
  scale(MMN_amplitude) ~ trial * group * block * z_handdynamometer + (1|SEGA_ID) + age + gender,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm)
```

### MMN Latency
```{r, warning=FALSE}
lmm <- lmer(
  scale(MMN_latency) ~ trial * group * block * z_handdynamometer+ (1|SEGA_ID) + gender + age,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm)
```

### P3a Amplitude
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3a_amplitude) ~ trial * group * block * z_handdynamometer + (1|SEGA_ID) + gender + age,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm) 
```

### P3a Latency
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3a_latency) ~ trial * group * block * z_handdynamometer+ (1|SEGA_ID) + gender + age,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm) 
```

### SEPR
```{r, warning=FALSE}
lmm <- lmer(
  scale(rpd) ~ trial * group * block * z_handdynamometer + (1|SEGA_ID),
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm) 
```

### BPS
```{r, warning=FALSE}
lmm <- lmer(
  scale(rpd_low) ~ trial * group * block * z_handdynamometer + (1|SEGA_ID),
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm) 
r2_nakagawa(lmm)
```

# **Trial Level**
## MMN Amplitude
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  scale(MMN_amplitude) ~ trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ trial), adjust = "tukey")
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation|block), adjust = "tukey")
emmeans(
  lmm, list(pairwise ~ block|manipulation), adjust = "tukey")
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## MMN Latency
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  scale(MMN_latency) ~ trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ trial), adjust = "tukey")
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation|block), adjust = "tukey")
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## P3a Amplitude
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3a_amplitude) ~ trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial x group
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ trial | group), "pairwise")
contrast(emmeans(lmm, ~ group | trial), "pairwise")
plot(emmeans(lmm, ~ trial|group))
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation | block), "pairwise")
plot(emmeans(lmm, ~ manipulation|block))
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## P3a Latency
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3a_latency) ~ trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ trial), adjust = "tukey")
```

### Plot: trial x manipulation x group x block
```{r, warning=FALSE}
emmip(lmm, ~ block|group * manipulation|trial)
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

## SEPR
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  scale(rpd) ~ trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ trial), adjust = "tukey")
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Post-hoc: manipulation
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

### Plot: SEPR over block
```{r, warning=FALSE}
ggplot(
  et_erp_trial,
  aes(
    x = trial_number_in_block,
    y = scale(rpd),
    group = trial,
    color = trial)) +
  geom_smooth() +
  theme_bw() + 
  ggtitle("SEPR (rpd) over block: A group comparison.") +
  facet_grid(cols = vars(group))
```

### Plot: SEPR over task
```{r, warning=FALSE}
et_erp_trial$binned_trial_number <- cut(
  et_erp_trial$oddball_trial_counter, c(
    1,  25,  50, 75,  100, 125,  150, 175, 200,  225, 250, 275, 300, 325, 350, 375, 400))
ggplot(et_erp_trial) + geom_boxplot(aes(binned_trial_number, rpd)) + 
  facet_grid(cols = vars(group))
```

## BPS
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  scale(rpd_low) ~ trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: manipulation
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation), adjust = "tukey")
```

### Post-hoc: manipulation x group
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group|manipulation), adjust = "tukey")
emmeans(
  lmm, list(pairwise ~ manipulation|group), adjust = "tukey")
emmip(lmm, ~ manipulation|group)
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ manipulation|block), adjust = "tukey")
```

### Post-hoc: group x block
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group|block), adjust = "tukey")
emmeans(
  lmm, list(pairwise ~ block|group), adjust = "tukey")
```

### Post-hoc: group
#### Hypothesis-driven post-hoc test without significant omnibus ANVOA
```{r, warning=FALSE}
emmeans(
  lmm, list(pairwise ~ group), adjust = "tukey")
```

### Plot: BPS over block
```{r, warning=FALSE}
ggplot(
  et_erp_trial,
  aes(
    x = trial_number_in_block,
    y = scale(rpd_low),
    group = trial,
    color = trial)) +
  geom_smooth() +
  theme_bw() + 
  ggtitle("BPS (rpd_low) over block: A group comparison.") +
  facet_grid(cols = vars(group))
```

### Plot: BPS over the task
```{r, warning=FALSE}
et_erp_trial$binned_trial_number <- cut(
  et_erp_trial$oddball_trial_counter, c(
    1,  25,  50, 75,  100, 125,  150, 175, 200,  225, 250, 275, 300, 325, 350, 375, 400))
ggplot(et_erp_trial[et_erp_trial$trial == "standard", ]) + geom_boxplot(aes(binned_trial_number, rpd_low)) + 
  facet_grid(cols = vars(group))
```

## Association between BPS and SEPR
```{r, warning=FALSE}
ggscatter(et_erp_trial[et_erp_trial$trial == "oddball", ], 
          x = "z_rpd_low",
          y = "z_rpd",
          add = "reg.line",
          conf.int = TRUE,
          cor.coef = TRUE,
          cor.method = "pearson",
          xlab = "scaled BPS (rpd_low)",
          ylab = "scaled SEPR (rpd)",
          title = "Association between SEPR + BPS in oddball trials")

ggscatter(et_erp_trial[et_erp_trial$trial == "standard", ], 
          x = "z_rpd_low",
          y = "z_rpd",
          add = "reg.line",
          conf.int = TRUE,
          cor.coef = TRUE,
          cor.method = "pearson",
          xlab = "scaled BPS (rpd_low)",
          ylab = "scaled SEPR (rpd)",
          title = "Association between SEPR + BPS in standard trials")
```

```{r, warning=FALSE}
lmm <- lmer(
  scale(rpd) ~ scale(rpd_low) * trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: group x rpd_low
```{r, warning=FALSE}
emtrends(lmm, ~ group, var = "rpd_low")
plot(emtrends(lmm, ~ group, var = "rpd_low"))
```

## Association between pupil data and ERPs
```{r, warning=FALSE}
crl <- cor(et_erp_trial[et_erp_trial$trial == "oddball", c(
  "z_rpd_low",
  "z_rpd",
  "z_MMN_amplitude",
  "z_P3a_amplitude"
)],
use="complete.obs")
crl
corrplot::corrplot(
  crl,
  method = "circle",
  title = "Association between pupil data and ERPs in oddball trials",
  mar=c(0,0,1,0))

crl <- cor(et_erp_trial[et_erp_trial$trial == "standard", c(
  "z_rpd_low",
  "z_rpd",
  "z_MMN_amplitude",
  "z_P3a_amplitude"
)],
use="complete.obs")
crl
corrplot::corrplot(
  crl,
  method = "circle",
  title = "Association between pupil data and ERPs in standard trials",
  mar=c(0,0,1,0))
```

## Does pupil data predict ERPs?
### Does SEPR/BPS predict MMN amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  scale(MMN_amplitude) ~ rpd * rpd_low * trial *  manipulation * group + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

```{r, warning=FALSE}
summary(lmm)
```

```{r, warning=FALSE}
emtrends(lmm, ~ group, var = c("rpd"))
```

### Does SEPR/BPS predict P3a amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  scale(P3a_amplitude) ~ rpd * rpd_low * trial *  manipulation * group + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

```{r, warning=FALSE}
emtrends(lmm, ~ manipulation | group, var = c("rpd_low"))
plot(emtrends(lmm, ~ manipulation | group, var = c("rpd_low")))
```

```{r, warning=FALSE}
emtrends(lmm, ~ manipulation, var = c("rpd_low"))
```

## Exploratory: Block pregression
### Model fit for BPS
```{r, warning=FALSE}
linear_fit <- lmer(
  scale(rpd_low) ~ trial * manipulation * group * trial_number_in_block * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial, REML = F)
anova(linear_fit)

quadratic_fit <- lmer(
  scale(rpd_low) ~ trial * manipulation * group * poly(trial_number_in_block, 2) * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial, REML = F)
anova(quadratic_fit)
r2_nakagawa(quadratic_fit) 

cubic_fit <- lmer(
  scale(rpd_low) ~ trial * manipulation * group * poly(trial_number_in_block, 3) * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial, REML = F)
anova(cubic_fit)
r2_nakagawa(cubic_fit) 

table_model_compare <- anova(linear_fit, quadratic_fit, cubic_fit)

table_model_compare <- cbind(
  c("linear_fit", "quadratic_fit", "cubic_fit"),
  table_model_compare
)

table_formatted_BPS <- table_model_compare %>% 
  kbl(caption = "Model comparision of trial_number_in_block on BPS",
      col.names = c("","number of parameters",'AIC','BIC','log likelihood','deviance','Chi-squared','df','p-value'),
      row.names = F) %>%
  kable_classic(full_width = F, html_font = "Cambria")

table_formatted_BPS
```

### Model fit for SEPR
```{r, warning=FALSE}
linear_fit <- lmer(
  scale(rpd) ~ trial * manipulation * group * trial_number_in_block * block+ (1|SEGA_ID) + pitch + age + gender,
  data = et_erp_trial, REML = F)
anova(linear_fit)
r2_nakagawa(linear_fit) 

quadratic_fit <- lmer(
  scale(rpd) ~ trial * manipulation * group * poly(trial_number_in_block, 2) * block + (1|SEGA_ID) + pitch + age + gender,
  data = et_erp_trial, REML = F)
anova(quadratic_fit)
r2_nakagawa(quadratic_fit) 

cubic_fit <- lmer(
  scale(rpd) ~ trial * manipulation * group * poly(trial_number_in_block, 3) * block + (1|SEGA_ID) + pitch + age + gender,
  data = et_erp_trial, REML = F)
anova(cubic_fit)
r2_nakagawa(cubic_fit) 

table_model_compare <- anova(linear_fit, quadratic_fit, cubic_fit)

table_model_compare <- cbind(
  c("linear_fit", "quadratic_fit", "cubic_fit"),
  table_model_compare
)

table_formatted_SEPR <- table_model_compare %>% 
  kbl(caption = "Model comparision of trial_number_in_block on SEPR",
      col.names = c("","number of parameters",'AIC','BIC','log likelihood','deviance','Chi-squared','df','p-value'),
      row.names = F) %>%
  kable_classic(full_width = F, html_font = "Cambria")

table_formatted_SEPR
```