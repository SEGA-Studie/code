---
title: "SEGA: ERP-ET Analysis (ASD-CON-MHC)"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: true
    theme: cerulean
    code_folding: hide
editor_options:
  chunk_output_type: console
  pdf_document:
    toc: yes
---
```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# REQUIRED PACKAGES
require(performance) # marginal + conditional R2
require(lme4) # linear-mixed-effects models
require(lmerTest, warn.conflicts = FALSE) # linear-mixed-effects models
require(emmeans, warn.conflicts = FALSE) # estimated marginal means (EMMs)
require(ggplot2, warn.conflicts = FALSE) # creating graphs
require(dplyr, warn.conflicts = FALSE) # for %>% operator
library(ggpubr, warn.conflicts = FALSE) # ggscatter()-function
library(knitr) # dynamic report generation
library(kableExtra) # table formatting
library(stringr) # for string modifications
library(tidyverse)

# PATHS
if (Sys.info()["sysname"] == "Linux") {
  home_path <- "~"
  project_path <- "/PowerFolders/project_sega"
  data_path <- "/PowerFolders/project_sega/data/AuditoryOddball"
  data_path_eeg <- "/PowerFolders/project_sega/data/AuditoryOddball_EEG"
  datapath <- paste0(home_path, data_path) # .csv + .hdf5 input files
  datapath_eeg <- paste0(home_path, data_path_eeg) # .txt input files (eeg)
  # List all .hdf and .csv files
  data_files <- list.files(path = datapath, full.names = TRUE)
}

if (Sys.info()["sysname"] == "Windows") {
  home_path <- "C:/Users/Nico"
  project_path <- "/PowerFolders/project_sega"
  data_path <- "/PowerFolders/project_sega/data/et auditory oddball"
  data_path_task<-"/PowerFolders/project_sega/data/task auditory oddball"
  data_path_eeg <- "/PowerFolders/project_sega/data/tests/eeg preprocessed auditory oddball"
  datapath <- paste0(home_path, data_path) # hdf5 input files
  datapath_task <- paste0(home_path, data_path_task) # hdf5 input files
  datapath_eeg <- paste0(home_path, data_path_eeg) # .txt input files (eeg)
  # List all .hdf and .csv files
  data_files <- c(list.files(path = datapath, full.names = TRUE),
                  list.files(path = datapath_task, full.names = TRUE))
}

if (Sys.info()["sysname"] == "Darwin") {
  home_path <- "~"
  project_path <- "/code"
  data_path <- "/code/input/AuditoryOddball/eyetracking"
  data_path_task <- "/code/input/AuditoryOddball/taskdata"
  data_path_eeg <- "/code/input/AuditoryOddball/eeg"
  datapath <- paste0(home_path, data_path) # .hdf5 input files
  datapath_task <- paste0(home_path, data_path_task) # .csv input files
  datapath_eeg <- paste0(home_path, data_path_eeg) # .txt input files (eeg)
  data_path_single_trial_eeg <- "/code/input/AuditoryOddball/eeg_single_trial"
  datapath_single_eeg <- paste0(home_path, data_path_single_trial_eeg)
  # List all .hdf and .csv files
  data_files <- c(
    list.files(path = datapath, full.names = TRUE),
    list.files(path = datapath_task, full.names = TRUE))
}

# Can be used to skip preprocessing and directly read proprocessed data from .rds file:
et_erp_subject <- readRDS(paste0(home_path,project_path,'/data/preprocessed_auditory_ET_ERP_subject.rds'))
et_erp_trial <- readRDS(paste0(home_path,project_path,'/data/preprocessed_auditory_ET_ERP_trial.rds'))
df_trial <- readRDS(paste0(home_path,project_path,'/data/preprocessed_auditory_ETdata.rds'))
```

# **Subject Level**
## Sample size
```{r, warning=FALSE}
length(unique(et_erp_subject$SEGA_ID))
table(et_erp_subject$group)/8
```

## Exclude subjects
*to balance age in groups, 1 subject per groups excluded*
```{r, warning=FALSE}
excluded_ids <- c("117", "152", "36") # to balance age between groups
et_erp_subject <- subset(et_erp_subject, ! (SEGA_ID %in% excluded_ids))
et_erp_trial <- subset(et_erp_trial, ! (SEGA_ID %in% excluded_ids))

length(unique(et_erp_subject$SEGA_ID))
table(et_erp_subject$group)/8
```

## Distributions of dependent variables
```{r, warning=FALSE}
hist(et_erp_subject$z_rpd,
     main = "Distribution of z_rpd (500-1500 ms)",
     xlab = "rpd)",
     breaks = 200)
hist(et_erp_subject$z_rpd_low,
     main = "Distribution of z_rpd_low (0-250 ms)",
     xlab = "rpd_low",
     xlim = c(-4, 6),
     breaks = 200)
hist(et_erp_subject$z_rpd_block,
     main = "Distribution of z_rpd_block",
     xlab = "rpd_block",
     xlim = c(-4, 4),
     breaks = 200)
hist(et_erp_subject$z_MMN_amplitude,
     main = "Distribution of z_MMN_amplitude (100-150 ms)",
     xlab = "MMN amplitude (FC1, FC2, FCz, Fz)",
     breaks = 200)
hist(et_erp_subject$z_P3a_amplitude,
     main = "Distribution of z_P3a_amplitude (150-250 ms)",
     xlab = "P3a amplitude (Cz, FCz)",
     ylim = c(0, 30),
     xlim = c(-4, 6),
     breaks = 200)
hist(et_erp_subject$z_P3b_amplitude,
     main = "Distribution of z_P3b_amplitude (250-500 ms)",
     xlab = "P3b amplitude (Pz)",
     xlim = c(-6, 8),
     breaks = 200)
```

## Sample Characteristics
```{r, warning=FALSE}
fun_return_descriptives <- function(group){
  group_df <- et_erp_subject[et_erp_subject$group == group, c("gender", "age", "SRS", "SCQ", "CBCL", "YSR", "SP2", "z_handdynamometer", "SEGA_ID", "verbal_IQ", "non_verbal_IQ")]
  n <- length(unique(group_df$SEGA_ID))
  male <- (length(which(group_df$gender == "mÃ¤nnlich"))/8)
  female <- (length(which(group_df$gender == "weiblich"))/8)
  gender_f_m <- paste(female,"/",male)
  age_mean <- round(mean(group_df$age, na.rm = TRUE), digits = 1)
  age_sd <- round(sd(group_df$age, na.rm = TRUE), digits = 1)
  age <- paste(age_mean, "(",age_sd,")" )
  SRS_mean <- round(mean(group_df$SRS, na.rm = TRUE), digits = 1)
  SRS_sd <- round(sd(group_df$SRS, na.rm = TRUE), digits = 1)
  SRS <- paste(SRS_mean, "(",SRS_sd,")")
  CBCL_mean <- round(mean(group_df$CBCL, na.rm = TRUE), digits = 1)
  CBCL_sd <- round(sd(group_df$CBCL, na.rm = TRUE), digits = 1)
  CBCL <- paste(CBCL_mean, "(",CBCL_sd,")")
  SCQ_mean <- round(mean(group_df$SCQ, na.rm = TRUE), digits = 1)
  SCQ_sd <- round(sd(group_df$SCQ, na.rm = TRUE), digits = 1)
  SCQ <- paste(SCQ_mean, "(", SCQ_sd, ")")
  YSR_mean <- round(mean(group_df$YSR, na.rm = TRUE), digits = 1)
  YSR_sd <- round(sd(group_df$YSR, na.rm = TRUE), digits = 1)
  YSR <- paste(YSR_mean, "(", YSR_sd, ")")
  SP2_mean <- round(mean(group_df$SP2, na.rm = TRUE), digits = 1)
  SP2_sd <- round(sd(group_df$SP2, na.rm = TRUE), digits = 1)
  SP2 <- paste(SCQ_mean, "(", SP2_sd, ")")
  grip_strength_mean <- round(mean(group_df$z_handdynamometer, na.rm = TRUE), digits = 1)
  grip_strength_sd <- round(sd(group_df$z_handdynamometer, na.rm = TRUE), digits = 1)
  grip_strength <- paste(grip_strength_mean, "(", grip_strength_sd, ")")
  verbal_IQ_mean <- round(mean(group_df$verbal_IQ, na.rm = TRUE), digits = 1)
  verbal_IQ_sd <- round(sd(group_df$verbal_IQ, na.rm = TRUE), digits = 1)
  verbal_IQ <- paste(verbal_IQ_mean, "(", verbal_IQ_sd, ")")
  non_verbal_IQ_mean <- round(mean(group_df$non_verbal_IQ, na.rm = TRUE), digits = 1)
  non_verbal_IQ_sd <- round(sd(group_df$non_verbal_IQ, na.rm = TRUE), digits = 1)
  non_verbal_IQ <- paste(non_verbal_IQ_mean, "(", non_verbal_IQ_sd, ")")
  group_description <- data.frame(
    n,
    gender_f_m,
    age,
    SRS,
    CBCL,
    SCQ,
    YSR,
    SP2,
    grip_strength,
    verbal_IQ,
    non_verbal_IQ)
  t(group_description)
}

## Descriptive statistics
asd_description <- fun_return_descriptives(group = "ASD")
colnames(asd_description) <- "ASD"
con_description <- fun_return_descriptives(group = "CON")
colnames(con_description) <- "CON"
mhc_description <- fun_return_descriptives(group = "MHC")
colnames(mhc_description) <- "MHC"

SCQ_anova <- aov(SCQ ~ group, data = et_erp_subject)
SCQ_anova_p <- summary(SCQ_anova)[[1]][["Pr(>F)"]][[1]]
age_anova <- aov(age ~ group, data = et_erp_subject)
age_anova_p <- summary(age_anova)[[1]][["Pr(>F)"]][[1]]
age_anova_p <- age_anova_p
CBCL_anova <- aov(CBCL ~ group, data = et_erp_subject)
CBCL_anova_p <- summary(CBCL_anova)[[1]][["Pr(>F)"]][[1]]
SRS_anova <- aov(SRS ~ group, data = et_erp_subject)
SRS_anova_p <- summary(SRS_anova)[[1]][["Pr(>F)"]][[1]]
YSR_anova <- aov(YSR ~ group, data = et_erp_subject)
YSR_anova_p <- summary(YSR_anova)[[1]][["Pr(>F)"]][[1]]
SP2_anova <- aov(SP2 ~ group, data = et_erp_subject)
SP2_anova_p <- summary(SP2_anova)[[1]][["Pr(>F)"]][[1]]
grip_strength_anova <- aov(z_handdynamometer ~ group, data = et_erp_subject)
grip_strength_anova_p <- summary(grip_strength_anova)[[1]][["Pr(>F)"]][[1]]
verbal_IQ_anova <- aov(verbal_IQ ~ group, data = et_erp_subject)
verbal_IQ_anova_p <- summary(verbal_IQ_anova)[[1]][["Pr(>F)"]][[1]]
non_verbal_IQ_anova <- aov(non_verbal_IQ ~ group, data = et_erp_subject)
non_verbal_IQ_anova_p <- summary(non_verbal_IQ_anova)[[1]][["Pr(>F)"]][[1]]
gender_chi2 <- chisq.test(et_erp_subject$gender, et_erp_subject$group)
gender_chi2_p <- gender_chi2$p.value
p_values <- c(
  NA,
  gender_chi2_p,
  age_anova_p,
  SRS_anova_p,
  CBCL_anova_p,
  SCQ_anova_p,
  SP2_anova_p,
  YSR_anova_p,
  grip_strength_anova_p,
  verbal_IQ_anova_p,
  non_verbal_IQ_anova_p)

p_value <- c()
for (p in p_values){
  ifelse (p < 0.001, p <- "< 0.001",
          ifelse(p < 0.01, p <- "< 0.01",
                 ifelse(p < 0.05, p <- "< 0.05", p <- p )))
  p_value <- c(p_value, p)
}

sample_table <- cbind(asd_description, con_description, mhc_description, p_value)
sample_description_table <- kable(sample_table, caption = "Sample description", digits = 4) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>% kable_styling
sample_description_table

## Plot SCQ
ggplot(et_erp_subject, aes(x = group, y = SCQ), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(24, 25.5, 21)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("SCQ") +
  theme(plot.title = element_text(face = "bold"))

## Plot SRS
ggplot(et_erp_subject, aes(x = group, y = SRS), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(42, 45, 40)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("SRS") +
  theme(plot.title = element_text(face = "bold"))

## Plot CBCL
ggplot(et_erp_subject, aes(x = group, y = CBCL), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(87, 90, 84)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("CBCL") +
  theme(plot.title = element_text(face = "bold"))

## Plot: YSR
ggplot(et_erp_subject, aes(x = group, y = YSR), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(87, 90, 84)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("YSR") +
  theme(plot.title = element_text(face="bold"))

## Plot: SP2-Auditiv
ggplot(et_erp_subject, aes(x = group, y = SP2), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(43, 46, 40)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("SP2-Auditiv") +
  theme(plot.title = element_text(face="bold"))

## Plot: Age
age_df <- et_erp_subject[!duplicated(et_erp_subject$SEGA_ID), c("SEGA_ID", "group", "age")]
ggplot(age_df, aes(x = group, y = age), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_jitter() +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(19.5, 20, 19)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("Age") +
  theme(plot.title = element_text(face="bold"))

## Plot: IQ-verbal
IQ_df <- et_erp_subject[!duplicated(et_erp_subject$SEGA_ID), c("SEGA_ID", "group", "verbal_IQ", "non_verbal_IQ")]
# IQ_df <- reshape::melt(IQ_df, value.name = "IQ", id = c("SEGA_ID", "group"))
# names(IQ_df)[names(IQ_df) == 'variable'] <- 'domain'
# names(IQ_df)[names(IQ_df) == 'value'] <- 'IQ'

ggplot(IQ_df, aes(x = group, y = verbal_IQ), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(135, 140, 130)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("IQ-verbal") +
  theme(plot.title = element_text(face="bold"))

## Plot: IQ-non-verbal
ggplot(IQ_df, aes(x = group, y = non_verbal_IQ), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(135, 140, 130)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("IQ-non-verbal") +
  theme(plot.title = element_text(face="bold"))
```

## MMN Amplitude
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ trial * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: trial
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ trial), "pairwise")
confint(contrast(emmeans(lmm, ~ trial), "pairwise"))
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|block), "pairwise")
confint(contrast(emmeans(lmm, ~ manipulation|block), "pairwise"))
emmip(lmm, ~ manipulation | block, CIs = T)
```

## MMN Latency
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_latency ~ trial * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

## P3a Amplitude
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ trial * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial x group
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ trial|group), "pairwise")
confint(contrast(emmeans(lmm, ~ trial|group), "pairwise"))
emmip(lmm, ~ trial|group, CI = T)
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(lmm, ~ manipulation|block)
contrast(emmeans(lmm, ~ manipulation|block), "pairwise")
emmip(lmm, ~ manipulation|block, CI = T)
```

## P3a Latency
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_latency ~ trial * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ trial), "pairwise")
confint(contrast(emmeans(lmm, ~ trial), "pairwise"))
```

## P3b Amplitude
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_P3b_amplitude ~ trial * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

#### Post-hoc: trial
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ trial), "pairwise")
confint(contrast(emmeans(lmm, ~ trial), "pairwise"))
emmip(lmm, ~ trial, CI = T)
```

#### Post-hoc: manipulation
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation), "pairwise")
confint(contrast(emmeans(lmm, ~ manipulation), "pairwise"))
emmip(lmm, ~ manipulation, CI = T)
```

## P3b Latency
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_P3b_latency ~ trial * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

#### Post-hoc: trial x manipulation x group
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ group|manipulation*trial), "pairwise")
confint(contrast(emmeans(lmm, ~ group|manipulation*trial), "pairwise"))
emmip(lmm, ~ manipulation|group*trial, CI = T)
```

## SEPR
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ trial * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ trial), "pairwise")
confint(contrast(emmeans(lmm, ~ trial), "pairwise"))
```

## BPS
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd_low ~ trial * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm) 
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(lmm, list(pairwise ~ trial))
```

### Post-hoc: manipulation x group
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|group), "pairwise")
confint(contrast(emmeans(lmm, ~ manipulation|group), "pairwise"))
emmip(lmm, ~ manipulation | group, CIs = T)
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|block), "pairwise")
confint(contrast(emmeans(lmm, ~ manipulation|block), "pairwise"))
emmip(lmm, ~ manipulation | block, CIs = T)
```

## Does BPS predict SEPR?
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ z_rpd_low * trial * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: BPS x group
```{r, warning=FALSE}
emtrends(lmm, ~ group, var = "z_rpd_low")
contrast(emtrends(lmm, ~ group, var = "z_rpd_low"))
confint(contrast(emtrends(lmm, ~ group, var = "z_rpd_low")))
```

## Does pupil data predict ERPs?
### Does SEPR/BPS predict MMN amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ z_rpd * z_rpd_low * trial *  manipulation * group + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

#### Post-hoc: SEPR x BPS x trial
```{r, warning=FALSE}
emtrends(lmm, ~ z_rpd_low * z_rpd | trial, var = 'z_rpd', at = list(z_rpd_low = c(-2,-1,0,1,2)))
contrast(emtrends(lmm, ~ z_rpd_low * z_rpd | trial, var = 'z_rpd', at = list(z_rpd_low = c(-2,-1,0,1,2))))
```

### Does SEPR/BPS predict P3a amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ z_rpd * z_rpd_low * trial *  manipulation * group + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

#### Post-hoc: BPS x trial x group
```{r, warning=FALSE}
emtrends(lmm, ~ z_rpd_low * trial * group, var = 'z_rpd_low')
contrast(emtrends(lmm, ~ z_rpd_low * trial * group, var = 'z_rpd_low'))
confint(contrast(emtrends(lmm, ~ z_rpd_low * trial * group, var = 'z_rpd_low')))
```

#### Post-hoc: SEPR x trial x manipulation x group
```{r, warning=FALSE}
emtrends(lmm, ~ z_rpd  * manipulation | group * trial, var = 'z_rpd')
contrast(emtrends(lmm, ~ z_rpd  * manipulation | group * trial, var = 'z_rpd'))
```

# **Trial Level**
## Distributions of dependent variables
```{r, warning=FALSE}
hist(et_erp_trial$z_rpd,
     main = "Distribution of rpd (500-1500 ms)",
     xlab = "rpd",
     breaks = 200)
hist(et_erp_trial$z_rpd_low,
     main = "Distribution of rpd_low (0-250 ms)",
     xlab = "rpd_low",
     xlim = c(-4, 6),
     breaks = 200)
hist(et_erp_trial$z_MMN_amplitude,
     main = "Distribution of MMN amplitude (100-150 ms)",
     xlab = "MMN amplitude (FC1, FC2, FCz, Fz)",
     xlim = c(-6, 6),
     breaks = 200)
hist(et_erp_trial$z_P3a_amplitude,
     main = "Distribution of P3a amplitude (150-250 ms)",
     xlab = "P3a amplitude (Cz, FCz)",
     breaks = 200)
```

## MMN Amplitude
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ trial * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(lmm, list(pairwise ~ trial))
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(lmm, list(pairwise ~ manipulation|block))
emmip(lmm, ~ manipulation|block, CI = T)
```

## MMN Latency
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_latency ~ trial * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(lmm, list(pairwise ~ trial))
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(lmm, list(pairwise ~ manipulation|block))
emmip(lmm, ~ manipulation|block, CI = T)
```

## P3a Amplitude
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: trial x group
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ trial | group))
emmeans(lmm, ~ trial | group)
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation | block), "pairwise")
emmeans(lmm, ~ manipulation | block)
emmip(lmm, ~ manipulation | block, CIs = T)
```

## P3a Latency
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_latency ~ trial * manipulation * group * block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: trial
```{r, warning=FALSE}
emmeans(lmm, list(pairwise ~ trial))
```

### Plot: trial x manipulation x group x block
```{r, warning=FALSE}
emmip(lmm, ~block|group * manipulation|trial, CIs = T)
```
 
## SEPR
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ trial * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

### post-hoc: trial
```{r, warning=FALSE}
emmeans(lmm, list(pairwise ~ trial))
```

## BPS
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd_low ~ trial * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: manipulation x group
```{r, warning=FALSE}
emmeans(lmm, list(pairwise ~ manipulation|group))
emmip(lmm, ~ manipulation|group, CIs = T)
```

### Post-hoc: block x group
```{r, warning=FALSE}
emmeans(lmm, list(pairwise ~ block|group))
emmip(lmm, ~ block|group, CIs = T)
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(lmm, list(pairwise ~ manipulation|block))
emmip(lmm, ~ manipulation|block, CIs = T)
```

## Does BPS predict SEPR?
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ z_rpd_low * trial * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: BPS x manipulation x block
```{r, warning=FALSE}
emtrends(lmm, ~ manipulation * block, var = "z_rpd_low")
contrast(emtrends(lmm, ~ manipulation * block, var = "z_rpd_low"))
confint(contrast(emtrends(lmm, ~ manipulation * block, var = "z_rpd_low")))
plot(emtrends(lmm, ~ manipulation * block, var = "z_rpd_low"))

emtrends(lmm, ~ block|manipulation, var = "z_rpd_low")
contrast(emtrends(lmm, ~ block|manipulation, var = "z_rpd_low"))
confint(contrast(emtrends(lmm, ~ block|manipulation, var = "z_rpd_low")))
```

### Post-hoc: BPS x manipulation x group
```{r, warning=FALSE}
emtrends(lmm, ~ group|manipulation, var = "z_rpd_low")
contrast(emtrends(lmm, ~ group|manipulation, var = "z_rpd_low"))
confint(contrast(emtrends(lmm, ~ group|manipulation, var = "z_rpd_low")))
plot(emtrends(lmm, ~ group|manipulation, var = "z_rpd_low"))
```

## Does pupil data predict ERPs?
### Does SEPR/BPS predict MMN amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ z_rpd * z_rpd_low * trial *  manipulation * group + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

#### Post-hoc: BPS x SEPR x group
```{r, warning=FALSE}
emtrends(lmm, ~ z_rpd_low * z_rpd | group, var = 'z_rpd', at = list(z_rpd_low = c(-2,-1,0,1,2)))
contrast(emtrends(lmm, ~ z_rpd_low * z_rpd | group, var = 'z_rpd', at = list(z_rpd_low = c(-2,-1,0,1,2))))
confint(contrast(emtrends(lmm, ~ z_rpd_low * z_rpd | group, var = 'z_rpd', at = list(z_rpd_low = c(-2,-1,0,1,2)))))
```

### Does SEPR/BPS predict P3a amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ z_rpd * z_rpd_low * trial *  manipulation * group + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

#### Post-hoc: BPS x manipulation x group
```{r, warning=FALSE}
emtrends(lmm, ~ manipulation | group, var = c("z_rpd_low"))
contrast(emtrends(lmm, ~ manipulation | group, var = c("z_rpd_low")))
confint(contrast(emtrends(lmm, ~ manipulation | group, var = c("z_rpd_low"))))
```

#### Post-hoc: SEPR x BPS x manipulation
```{r, warning=FALSE}
emtrends(lmm, ~ z_rpd_low * z_rpd | manipulation, var = 'z_rpd', at = list(z_rpd_low = c(-2,-1,0,1,2)))
contrast(emtrends(lmm, ~ z_rpd_low * z_rpd | manipulation, var = 'z_rpd', at = list(z_rpd_low = c(-2,-1,0,1,2))))
```

# **Exploratory Analyses**
## Grip strength (z-values)
### MMN Amplitude
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ trial * group * block * z_handdynamometer + (1|SEGA_ID) + age + gender,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm)
```

### MMN Latency
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_latency ~ trial * group * block * z_handdynamometer + (1|SEGA_ID) + gender + age,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm)
```

### P3a Amplitude
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ trial * group * block * z_handdynamometer + (1|SEGA_ID) + gender + age,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm) 
```

### P3a Latency
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_latency ~ trial * group * block * z_handdynamometer+ (1|SEGA_ID) + gender + age,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm) 
```

### SEPR
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ trial * group * block * z_handdynamometer + (1|SEGA_ID),
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm) 
```

### BPS
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd_low ~ trial * group * block * z_handdynamometer + (1|SEGA_ID),
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm) 
r2_nakagawa(lmm)
```

## SEPR over the task
### Model
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ trial * manipulation * group * block * oddball_trial_counter + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: manipulation x oddball_trial_counter
```{r, warning=FALSE}
emtrends(lmm,~ manipulation, var = 'oddball_trial_counter')
```

### Plot: SEPR over task by group
```{r, warning=FALSE}
et_erp_trial$binned_trial_number <- cut(
  et_erp_trial$oddball_trial_counter, c(
    1,  103, 206, 309, 412))
ggplot(et_erp_trial[et_erp_trial$trial == "oddball", ]) + geom_boxplot(aes(binned_trial_number, z_rpd)) + 
  facet_grid(cols = vars(group)) + 
  ggtitle("SEPR in oddball trials during the task, \nsplit by group") +
  theme(plot.title = element_text(face = "bold", size = 14))
```

## SEPR per block
### Model
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ trial * manipulation * group * block * trial_number_in_block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: manipulation x trial_number_in_block
```{r, warning=FALSE}
emtrends(lmm,~ manipulation, var = 'trial_number_in_block')
```

### Plot: SEPR progression for each block
```{r, warning=FALSE}
bin_size <- 20
df_trial <- df_trial %>%
  mutate(trial_number_in_block_binned = factor(trial_number_in_block%/%bin_size*20))
ggplot(
  df_trial[df_trial$phase %in% c("oddball_block", "oddball_block_rev") & df_trial$trial == "oddball", ],
  aes(x = trial_number_in_block_binned,
      y = rpd)) + 
  geom_boxplot() + 
  facet_grid(
    rows = vars(block),
    cols = vars(manipulation)) +
  theme_bw() +
  ggtitle("SEPR in oddball trials during blocks, \nsplit by forward + reverse and before + after manipulation") +
  theme(plot.title = element_text(face = "bold", size = 14))
```

### Plot: SEPR over block by group
```{r, warning=FALSE}
et_erp_trial$binned_trial_number <- cut(
  et_erp_trial$trial_number_in_block, c(
    0,  20, 40, 60, 80, 100))
ggplot(et_erp_trial[et_erp_trial$trial == "oddball", ]) + geom_boxplot(aes(binned_trial_number, z_rpd)) + 
  facet_grid(cols = vars(group)) + 
  ggtitle("SEPR in oddball trials during blocks, split by group") +
  theme(plot.title = element_text(face = "bold", size = 14))
```

## BPS over task
### Model
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd_low ~ trial * manipulation * group * block * oddball_trial_counter + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: manipulation x block x oddball_trial_counter
```{r, warning=FALSE}
emtrends(lmm,~ manipulation * block, var = 'oddball_trial_counter')
```

### Post-hoc: group x block x oddball_trial_counter
```{r, warning=FALSE}
emtrends(lmm,~ group * block, var = 'oddball_trial_counter')
```


### Plot: BPS over the task
```{r, warning=FALSE}
et_erp_trial$binned_trial_number <- cut(
  et_erp_trial$oddball_trial_counter, c(
    1,  103, 206, 309, 412))
ggplot(et_erp_trial[et_erp_trial$trial == "standard", ]) + geom_boxplot(aes(binned_trial_number, z_rpd_low)) + 
  facet_grid(cols = vars(group)) + 
  ggtitle("BPS in standard trials during the task, split by group") +
  theme(plot.title = element_text(face = "bold", size = 14))
```

## BPS per block
### Model
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd_low ~ trial * manipulation * group * block * trial_number_in_block + (1|SEGA_ID),
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: manipulation x group x block x trial_number_in_block
```{r, warning=FALSE}
emtrends(lmm,~ manipulation * group|block, var = 'trial_number_in_block')
```

### Plot: BPS block progression by group
```{r, warning=FALSE}
bin_size <- 20
df_trial <- df_trial %>%
  mutate(trial_number_in_block_binned = factor(trial_number_in_block%/%bin_size*20))
ggplot(
  df_trial[df_trial$phase %in% c("oddball_block", "oddball_block_rev") & df_trial$trial == "standard", ],
  aes(x = trial_number_in_block_binned,
      y = scale(rpd_low))) + 
  geom_boxplot() + 
  facet_grid(
    rows = vars(block),
    cols = vars(manipulation)) +
  theme_bw() +
  ggtitle("BPS in standard trials during blocks, \nsplit by forward + reverse and before + after manipulation") +
  theme(plot.title = element_text(face = "bold", size = 14))
```

## Model fit for BPS
```{r, warning=FALSE}
linear_fit <- lmer(
  z_rpd_low ~ trial * manipulation * group * trial_number_in_block * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial, REML = F)
anova(linear_fit)

quadratic_fit <- lmer(
  z_rpd_low ~ trial * manipulation * group * poly(trial_number_in_block, 2) * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial, REML = F)
anova(quadratic_fit)
r2_nakagawa(quadratic_fit) 

cubic_fit <- lmer(
  z_rpd_low ~ trial * manipulation * group * poly(trial_number_in_block, 3) * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial, REML = F)
anova(cubic_fit)
r2_nakagawa(cubic_fit) 

table_model_compare <- anova(linear_fit, quadratic_fit, cubic_fit)

table_model_compare <- cbind(
  c("linear_fit", "quadratic_fit", "cubic_fit"),
  table_model_compare
)

table_formatted_BPS <- table_model_compare %>% 
  kbl(caption = "Model comparision of trial_number_in_block on BPS",
      col.names = c("","number of parameters",'AIC','BIC','log likelihood','deviance','Chi-squared','df','p-value'),
      row.names = F) %>%
  kable_classic(full_width = F, html_font = "Cambria")

table_formatted_BPS
```

## Model fit for SEPR
```{r, warning=FALSE}
linear_fit <- lmer(
  z_rpd ~ trial * manipulation * group * trial_number_in_block * block+ (1|SEGA_ID) + pitch + age + gender,
  data = et_erp_trial, REML = F)
anova(linear_fit)
r2_nakagawa(linear_fit) 

quadratic_fit <- lmer(
  z_rpd ~ trial * manipulation * group * poly(trial_number_in_block, 2) * block + (1|SEGA_ID) + pitch + age + gender,
  data = et_erp_trial, REML = F)
anova(quadratic_fit)
r2_nakagawa(quadratic_fit) 

cubic_fit <- lmer(
  z_rpd ~ trial * manipulation * group * poly(trial_number_in_block, 3) * block + (1|SEGA_ID) + pitch + age + gender,
  data = et_erp_trial, REML = F)
anova(cubic_fit)
r2_nakagawa(cubic_fit) 

table_model_compare <- anova(linear_fit, quadratic_fit, cubic_fit)

table_model_compare <- cbind(
  c("linear_fit", "quadratic_fit", "cubic_fit"),
  table_model_compare
)

table_formatted_SEPR <- table_model_compare %>% 
  kbl(caption = "Model comparision of trial_number_in_block on SEPR",
      col.names = c("","number of parameters",'AIC','BIC','log likelihood','deviance','Chi-squared','df','p-value'),
      row.names = F) %>%
  kable_classic(full_width = F, html_font = "Cambria")

table_formatted_SEPR
```
