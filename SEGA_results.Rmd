---
title: "SEGA: ERP-ET Analysis (ASD-CON-MHC)"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
    theme: cerulean
    code_folding: hide
  word_document:
    toc: yes
editor_options:
  chunk_output_type: console
  pdf_document:
    toc: yes
---
```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# REQUIRED PACKAGES
require(performance) # marginal + conditional R2
require(lme4) # linear-mixed-effects models
require(lmerTest, warn.conflicts = FALSE) # linear-mixed-effects models
require(emmeans, warn.conflicts = FALSE) # estimated marginal means (EMMs)
require(ggplot2, warn.conflicts = FALSE) # creating graphs
require(dplyr, warn.conflicts = FALSE) # for %>% operator
library(ggpubr, warn.conflicts = FALSE) # ggscatter()-function
library(knitr) # dynamic report generation
library(kableExtra) # table formatting
library(stringr) # for string modifications
library(tidyverse)
library(simr)
library(gridExtra) # arrange ggplots
library(ggpubr) # get legend of ggplots

# PATHS
if (Sys.info()["sysname"] == "Linux") {
  home_path <- "~"
  project_path <- "/PowerFolders/project_sega"
  data_path <- "/PowerFolders/project_sega/data/AuditoryOddball"
  data_path_eeg <- "/PowerFolders/project_sega/data/AuditoryOddball_EEG"
  datapath <- paste0(home_path, data_path) # .csv + .hdf5 input files
  datapath_eeg <- paste0(home_path, data_path_eeg) # .txt input files (eeg)
  # List all .hdf and .csv files
  data_files <- list.files(path = datapath, full.names = TRUE)
}

if (Sys.info()["sysname"] == "Windows") {
  home_path <- "C:/Users/Nico"
  project_path <- "/PowerFolders/project_sega"
  data_path <- "/PowerFolders/project_sega/data/et auditory oddball"
  data_path_task<-"/PowerFolders/project_sega/data/task auditory oddball"
  data_path_eeg <- "/PowerFolders/project_sega/data/tests/eeg preprocessed auditory oddball"
  datapath <- paste0(home_path, data_path) # hdf5 input files
  datapath_task <- paste0(home_path, data_path_task) # hdf5 input files
  datapath_eeg <- paste0(home_path, data_path_eeg) # .txt input files (eeg)
  # List all .hdf and .csv files
  data_files <- c(list.files(path = datapath, full.names = TRUE),
                  list.files(path = datapath_task, full.names = TRUE))
}

if (Sys.info()["sysname"] == "Darwin") {
  home_path <- "~"
  project_path <- "/code"
  data_path <- "/code/input/AuditoryOddball/eyetracking"
  data_path_task <- "/code/input/AuditoryOddball/taskdata"
  data_path_eeg <- "/code/input/AuditoryOddball/eeg"
  datapath <- paste0(home_path, data_path) # .hdf5 input files
  datapath_task <- paste0(home_path, data_path_task) # .csv input files
  datapath_eeg <- paste0(home_path, data_path_eeg) # .txt input files (eeg)
  data_path_single_trial_eeg <- "/code/input/AuditoryOddball/eeg_single_trial"
  datapath_single_eeg <- paste0(home_path, data_path_single_trial_eeg)
  # List all .hdf and .csv files
  data_files <- c(
    list.files(path = datapath, full.names = TRUE),
    list.files(path = datapath_task, full.names = TRUE))
}

# Can be used to skip preprocessing and directly read proprocessed data from .rds file:
et_erp_subject <- readRDS(paste0(home_path,project_path,'/data/preprocessed_auditory_ET_ERP_subject.rds'))
et_erp_trial <- readRDS(paste0(home_path,project_path,'/data/preprocessed_auditory_ET_ERP_trial.rds'))
df_trial <- readRDS(paste0(home_path,project_path,'/data/preprocessed_auditory_ETdata.rds'))
MMN_diff <- readRDS(paste0(home_path,project_path,'/data/preprocessed_auditory_MMN_diff.rds'))
```

```{r, warning=FALSE}
# Renaming the variable "trial" into "stimulus" to match terminology in the paper
names(et_erp_subject)[names(et_erp_subject) == "trial"] <- "stimulus"
names(et_erp_trial)[names(et_erp_trial) == "trial"] <- "stimulus"
names(df_trial)[names(df_trial) == "trial"] <- "stimulus"
```

# **Subject Level**
## Sample size
```{r, warning=FALSE}
length(unique(et_erp_subject$SEGA_ID))
table(et_erp_subject$group)/8
```

## Distributions of dependent variables
```{r, warning=FALSE}
par(mfrow = c(3,2), mar = c(4, 4, 2, 1))
hist(et_erp_subject$z_rpd,
     main = "Distribution of z_rpd (500-1500 ms)",
     xlab = "rpd)",
     breaks = 200)
hist(et_erp_subject$z_rpd_low,
     main = "Distribution of z_rpd_low (0-250 ms)",
     xlab = "rpd_low",
     xlim = c(-4, 6),
     breaks = 200)
hist(et_erp_subject$z_rpd_block,
     main = "Distribution of z_rpd_block",
     xlab = "rpd_block",
     xlim = c(-4, 4),
     breaks = 200)
hist(et_erp_subject$z_MMN_amplitude,
     main = "Distribution of z_MMN_amplitude (100-150 ms)",
     xlab = "MMN amplitude (FC1, FC2, FCz, Fz)",
     breaks = 200)
hist(et_erp_subject$z_P3a_amplitude,
     main = "Distribution of z_P3a_amplitude (150-250 ms)",
     xlab = "P3a amplitude (Cz, FCz)",
     ylim = c(0, 30),
     xlim = c(-4, 6),
     breaks = 200)
hist(et_erp_subject$z_P3b_amplitude,
     main = "Distribution of z_P3b_amplitude (250-500 ms)",
     xlab = "P3b amplitude (Pz)",
     xlim = c(-6, 8),
     breaks = 200)
par(mfrow = c(1, 1))
```

## Sample Characteristics
```{r, warning=FALSE}
## mean + sd for each group
fun_return_descriptives <- function(group){
  group_df <- et_erp_subject[
    et_erp_subject$group == group,
    c("gender", "age", "SRS", "SCQ", "CBCL", "YSR", "SP2","z_grip_strength", "SEGA_ID",
      "verbal_IQ", "non_verbal_IQ","included_trials_et", "included_trials_eeg")]
  n <- length(unique(group_df$SEGA_ID))
  male <- (length(which(group_df$gender == "mÃ¤nnlich"))/8)
  female <- (length(which(group_df$gender == "weiblich"))/8)
  gender_f_m <- paste(female,"/",male)
  age_mean <- round(mean(group_df$age, na.rm = TRUE), digits = 1)
  age_sd <- round(sd(group_df$age, na.rm = TRUE), digits = 1)
  age <- paste(age_mean, "(",age_sd,")" )
  SRS_mean <- round(mean(group_df$SRS, na.rm = TRUE), digits = 1)
  SRS_sd <- round(sd(group_df$SRS, na.rm = TRUE), digits = 1)
  SRS <- paste(SRS_mean, "(",SRS_sd,")")
  CBCL_mean <- round(mean(group_df$CBCL, na.rm = TRUE), digits = 1)
  CBCL_sd <- round(sd(group_df$CBCL, na.rm = TRUE), digits = 1)
  CBCL <- paste(CBCL_mean, "(",CBCL_sd,")")
  SCQ_mean <- round(mean(group_df$SCQ, na.rm = TRUE), digits = 1)
  SCQ_sd <- round(sd(group_df$SCQ, na.rm = TRUE), digits = 1)
  SCQ <- paste(SCQ_mean, "(", SCQ_sd, ")")
  YSR_mean <- round(mean(group_df$YSR, na.rm = TRUE), digits = 1)
  YSR_sd <- round(sd(group_df$YSR, na.rm = TRUE), digits = 1)
  YSR <- paste(YSR_mean, "(", YSR_sd, ")")
  SP2_mean <- round(mean(group_df$SP2, na.rm = TRUE), digits = 1)
  SP2_sd <- round(sd(group_df$SP2, na.rm = TRUE), digits = 1)
  SP2 <- paste(SCQ_mean, "(", SP2_sd, ")")
  grip_strength_mean <- round(mean(group_df$z_grip_strength, na.rm = TRUE), digits = 1)
  grip_strength_sd <- round(sd(group_df$z_grip_strength, na.rm = TRUE), digits = 1)
  grip_strength <- paste(grip_strength_mean, "(", grip_strength_sd, ")")
  verbal_IQ_mean <- round(mean(group_df$verbal_IQ, na.rm = TRUE), digits = 1)
  verbal_IQ_sd <- round(sd(group_df$verbal_IQ, na.rm = TRUE), digits = 1)
  verbal_IQ <- paste(verbal_IQ_mean, "(", verbal_IQ_sd, ")")
  non_verbal_IQ_mean <- round(mean(group_df$non_verbal_IQ, na.rm = TRUE), digits = 1)
  non_verbal_IQ_sd <- round(sd(group_df$non_verbal_IQ, na.rm = TRUE), digits = 1)
  non_verbal_IQ <- paste(non_verbal_IQ_mean, "(", non_verbal_IQ_sd, ")")
  included_trials_eeg <- paste(round((mean(group_df$included_trials_eeg))*100, 1), "%")
  included_trials_et <- paste(round((mean(group_df$included_trials_et))*100, 1), "%")
  group_description <- data.frame(
    n,
    gender_f_m,
    age,
    SRS,
    CBCL,
    SCQ,
    YSR,
    SP2,
    grip_strength,
    verbal_IQ,
    non_verbal_IQ,
    included_trials_eeg,
    included_trials_et)
  t(group_description)
}

## p-values for descriptive statistics
asd_description <- fun_return_descriptives(group = "ASD")
colnames(asd_description) <- "ASD"
con_description <- fun_return_descriptives(group = "CON")
colnames(con_description) <- "CON"
mhc_description <- fun_return_descriptives(group = "MHC")
colnames(mhc_description) <- "MHC"

SCQ_anova <- aov(SCQ ~ group, data = et_erp_subject)
SCQ_anova_p <- summary(SCQ_anova)[[1]][["Pr(>F)"]][[1]]
age_anova <- aov(age ~ group, data = et_erp_subject)
age_anova_p <- summary(age_anova)[[1]][["Pr(>F)"]][[1]]
CBCL_anova <- aov(CBCL ~ group, data = et_erp_subject)
CBCL_anova_p <- summary(CBCL_anova)[[1]][["Pr(>F)"]][[1]]
SRS_anova <- aov(SRS ~ group, data = et_erp_subject)
SRS_anova_p <- summary(SRS_anova)[[1]][["Pr(>F)"]][[1]]
YSR_anova <- aov(YSR ~ group, data = et_erp_subject)
YSR_anova_p <- summary(YSR_anova)[[1]][["Pr(>F)"]][[1]]
SP2_anova <- aov(SP2 ~ group, data = et_erp_subject)
SP2_anova_p <- summary(SP2_anova)[[1]][["Pr(>F)"]][[1]]
grip_strength_anova <- aov(z_grip_strength ~ group, data = et_erp_subject)
grip_strength_anova_p <- summary(grip_strength_anova)[[1]][["Pr(>F)"]][[1]]
verbal_IQ_anova <- aov(verbal_IQ ~ group, data = et_erp_subject)
verbal_IQ_anova_p <- summary(verbal_IQ_anova)[[1]][["Pr(>F)"]][[1]]
non_verbal_IQ_anova <- aov(non_verbal_IQ ~ group, data = et_erp_subject)
non_verbal_IQ_anova_p <- summary(non_verbal_IQ_anova)[[1]][["Pr(>F)"]][[1]]
gender_chi2 <- chisq.test(et_erp_subject$gender, et_erp_subject$group)
gender_chi2_p <- gender_chi2$p.value
included_trials_et_anova <- aov(included_trials_et ~ group, data = et_erp_subject)
included_trials_et_p <- summary(included_trials_et_anova)[[1]][["Pr(>F)"]][[1]]
included_trials_eeg_anova <- aov(included_trials_eeg ~ group, data = et_erp_subject)
included_trials_eeg_p <- summary(included_trials_eeg_anova)[[1]][["Pr(>F)"]][[1]]

p_values <- c(
  NA,
  gender_chi2_p,
  age_anova_p,
  SRS_anova_p,
  CBCL_anova_p,
  SCQ_anova_p,
  SP2_anova_p,
  YSR_anova_p,
  grip_strength_anova_p,
  verbal_IQ_anova_p,
  non_verbal_IQ_anova_p,
  round(included_trials_et_p, 2),
  included_trials_eeg_p)

p_value <- c()
for (p in p_values){
  ifelse (p < 0.001, p <- "< 0.001",
          ifelse(p < 0.01, p <- "< 0.01",
                 ifelse(p < 0.05, p <- "< 0.05", p <- p )))
  p_value <- c(p_value, p)
}

sample_table <- cbind(asd_description, con_description, mhc_description, p_value)
# Redo table row and column names
rownames(sample_table)[rownames(sample_table) == "grip_strength"] <- "grip strength [z]"
rownames(sample_table)[rownames(sample_table) == "gender_f_m"] <- "gender (f/m)"
rownames(sample_table)[rownames(sample_table) == "verbal_IQ"] <- "verbal IQ"
rownames(sample_table)[rownames(sample_table) == "non_verbal_IQ"] <- "non verbal IQ"
rownames(sample_table)[rownames(sample_table) == "included_trials_eeg"] <- "included eeg trials [%]"
rownames(sample_table)[rownames(sample_table) == "included_trials_et"] <- "included et trials [%]"
colnames(sample_table)[colnames(sample_table) == "p_value"] <- "p value"

sample_description_table <- kable(sample_table, caption = "Sample description", digits = 4) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>% kable_styling
sample_description_table

# Supplements: No of trials per condition
fun_trials_per_cond <- function(group, variable){
  group_df <- droplevels(et_erp_trial[et_erp_trial$group == group, ])
  # subjects starting with 500 Hz oddball
  ## block 1
  df_before_forward_O500_S750 <- group_df %>% filter(
    (manipulation == "before" & phase == "oddball_block" & stimulus == "oddball" & pitch == "500") |
      (manipulation == "before" & phase == "oddball_block" & stimulus == "standard" & pitch == "750"))
  sample_size <- length(unique(df_before_forward_O500_S750$SEGA_ID))
  max_trials <- sample_size *100
  before_forward_O500_S750 <- paste(round(((sum(!is.na(df_before_forward_O500_S750[variable]), na.rm = T))/max_trials)*100, 2), "%")
  ## block 2
  df_before_reverse_O750_S500 <- group_df %>% filter(
    (manipulation == "before" & phase == "oddball_block_rev" & stimulus == "oddball" & pitch == "750") |
      (manipulation == "before" & phase == "oddball_block_rev" & stimulus == "standard" & pitch == "500"))
  before_reverse_O750_S500 <- paste(round(((sum(!is.na(df_before_reverse_O750_S500[variable]), na.rm = T))/max_trials)*100, 2), "%")
  ## block 3
  df_after_forward_O500S750 <- group_df %>% filter(
    (manipulation == "after" & phase == "oddball_block" & stimulus == "oddball" & pitch == "500") |
      (manipulation == "after" & phase == "oddball_block" & stimulus == "standard" & pitch == "750"))
  after_forward_O500S750 <- paste(round(((sum(!is.na(df_after_forward_O500S750[variable]), na.rm = T))/max_trials)*100, 2), "%")
  # block 4
  df_after_reverse_O750S500 <- group_df %>% filter(
    (manipulation == "after" & phase == "oddball_block_rev" & stimulus == "oddball" & pitch == "750") |
      (manipulation == "after" & phase == "oddball_block_rev" & stimulus == "standard" & pitch == "500"))
  after_reverse_O750S500 <- paste(round(((sum(!is.na(df_after_reverse_O750S500[variable]), na.rm = T))/max_trials)*100, 2), "%")
  # subjects starting with 750 Hz oddball
  ## block 1
  df_before_forward_O750_S500 <- group_df %>% filter(
    (manipulation == "before" & phase == "oddball_block" & stimulus == "oddball" & pitch == "750") |
      (manipulation == "before" & phase == "oddball_block" & stimulus == "standard" & pitch == "500"))
  sample_size <- length(unique(df_before_forward_O750_S500$SEGA_ID))
  max_trials <- sample_size *100
  before_forward_O750_S500 <- paste(round(((sum(!is.na(df_before_forward_O750_S500[variable]), na.rm = T))/max_trials)*100, 2), "%")
  ## block 2
  df_before_reverse_O500S750 <- group_df %>% filter(
    (manipulation == "before" & phase == "oddball_block_rev" & stimulus == "oddball" & pitch == "500") |
      (manipulation == "before" & phase == "oddball_block_rev" & stimulus == "standard" & pitch == "750"))
  before_reverse_O500S750 <- paste(round(((sum(!is.na(df_before_reverse_O500S750[variable]), na.rm = T))/max_trials)*100, 2), "%")
  ## block 3
  df_after_forward_O750_S500 <- group_df %>% filter(
    (manipulation == "after" & phase == "oddball_block" & stimulus == "oddball" & pitch == "750") |
      (manipulation == "after" & phase == "oddball_block" & stimulus == "standard" & pitch == "500"))
  after_forward_O750_S500 <- paste(round(((sum(!is.na(df_after_forward_O750_S500[variable]), na.rm = T))/max_trials)*100, 2), "%")
  ## block 4
  df_after_reverse_O500S750 <- group_df %>% filter(
    (manipulation == "after" & phase == "oddball_block_rev" & stimulus == "oddball" & pitch == "500") |
      (manipulation == "after" & phase == "oddball_block_rev" & stimulus == "standard" & pitch == "750"))
  after_reverse_O500S750 <- paste(round(((sum(!is.na(df_after_reverse_O500S750[variable]), na.rm = T))/max_trials)*100, 2), "%")
  
   trial_per_condition <- data.frame(
     before_forward_O500_S750,
     before_reverse_O750_S500,
     after_forward_O500S750,
     after_reverse_O750S500,
     before_forward_O750_S500,
     before_reverse_O500S750,
     after_forward_O750_S500,
     after_reverse_O500S750)
   t(trial_per_condition)
   }

# Call function for each group for EEG
asd_trials_per_cond_eeg <- fun_trials_per_cond(group = "ASD", variable = "z_MMN_amplitude")
colnames(asd_trials_per_cond_eeg) <- "ASD"
con_trials_per_cond_eeg <- fun_trials_per_cond(group = "CON", variable = "z_MMN_amplitude")
colnames(con_trials_per_cond_eeg) <- "CON"
mhc_trials_per_cond_eeg <- fun_trials_per_cond(group = "MHC", variable = "z_MMN_amplitude")
colnames(mhc_trials_per_cond_eeg) <- "MHC"
# Call function for each group for ET
asd_trials_per_cond_et <- fun_trials_per_cond(group = "ASD", variable = "z_rpd")
colnames(asd_trials_per_cond_et) <- "ASD"
con_trials_per_cond_et <- fun_trials_per_cond(group = "CON", variable = "z_rpd")
colnames(con_trials_per_cond_et) <- "CON"
mhc_trials_per_cond_et <- fun_trials_per_cond(group = "MHC", variable = "z_rpd")
colnames(mhc_trials_per_cond_et) <- "MHC"

condition_table <- cbind(
  asd_trials_per_cond_eeg, con_trials_per_cond_eeg, mhc_trials_per_cond_eeg,
  asd_trials_per_cond_et, con_trials_per_cond_et, mhc_trials_per_cond_et)

condition_trials_table <- kable(
  condition_table, align = "c", caption = "Number of included trials per condition") %>% 
  kable_classic() %>%
  kable_styling(full_width = FALSE) %>%
  add_header_above(c(" " = 1, "Eye Tracking" = 3, "EEG" = 3))
condition_trials_table

## Plot SCQ
ggplot(et_erp_subject, aes(x = group, y = SCQ), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(24, 25.5, 21)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("SCQ") +
  theme(plot.title = element_text(face = "bold"))

## Plot SRS
ggplot(et_erp_subject, aes(x = group, y = SRS), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(42, 45, 40)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("SRS") +
  theme(plot.title = element_text(face = "bold"))

## Plot CBCL
ggplot(et_erp_subject, aes(x = group, y = CBCL), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(87, 90, 84)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("CBCL") +
  theme(plot.title = element_text(face = "bold"))

## Plot: YSR
ggplot(et_erp_subject, aes(x = group, y = YSR), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(87, 90, 84)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("YSR") +
  theme(plot.title = element_text(face="bold"))

## Plot: SP2-Auditiv
ggplot(et_erp_subject, aes(x = group, y = SP2), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(43, 46, 40)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("SP2-Auditiv") +
  theme(plot.title = element_text(face="bold"))

## Plot: Age
age_df <- et_erp_subject[!duplicated(et_erp_subject$SEGA_ID), c("SEGA_ID", "group", "age")]
ggplot(age_df, aes(x = group, y = age), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_jitter() +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(19.5, 20, 19)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("Age") +
  theme(plot.title = element_text(face="bold"))

## Plot: IQ-verbal
IQ_df <- et_erp_subject[!duplicated(et_erp_subject$SEGA_ID), c("SEGA_ID", "group", "verbal_IQ", "non_verbal_IQ")]
plot_verbal_iq <- ggplot(IQ_df, aes(x = group, y = verbal_IQ), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(135, 140, 130)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("IQ-verbal") +
  theme(plot.title = element_text(face="bold")) +
  theme(plot.margin = unit(c(1, 0.5, 0.5, 0.5), "cm"))

## Plot: IQ-non-verbal
plot_non_verbal_iq <- ggplot(IQ_df, aes(x = group, y = non_verbal_IQ), col = "group") + 
  geom_boxplot(fill = "grey") +
  geom_signif(comparisons = list(c("ASD", "CON"), c("ASD", "MHC"), c("MHC", "CON")),
              map_signif_level=TRUE,
              y_position = c(135, 140, 130)) +
  theme_bw() + 
  theme_classic() +
  ggtitle("IQ-non-verbal") +
  theme(plot.title = element_text(face="bold")) +
  theme(plot.margin = unit(c(1, 0.5, 0.5, 0.5), "cm"))

grid.arrange(plot_verbal_iq, plot_non_verbal_iq, ncol = 2)
```

## Power Analysis
```{r, warning=FALSE, message = FALSE, echo = FALSE, results = 'hide'}
n_size<- 141
k_size<-4*100
subj <- factor(1:n_size)
trial_id <- 1:k_size
condition <- c("before", "after")
group <- c("ASD", "MHC", "CON")

subj_full <- rep(subj, k_size)
trial_full <- rep(trial_id, each=n_size)
condition_full <- rep(condition, each=k_size*n_size/2)
group_full <- rep(group, k_size*n_size/3)

covars <- data.frame(id=subj_full, trial=trial_full, condition=condition_full, group=group_full)
fixed <- c(0.1, 0.2, 0.2, 0.2, 0.1, 0.1)
rand <- list(0.05)
res <- 1.2

model <- makeLmer(
  y ~ group*condition + (1|id), fixef=fixed, VarCorr=rand, sigma=res, data=covars)

power_interaction <- powerSim(model, nsim=1000, test = fcompare(y ~ group + condition))
power_curve_interaction <- powerCurve(model, test = fcompare(y ~ group + condition), along = "id")
plot(power_curve_interaction)
```

## SEPR
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: stimulus
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ stimulus), "pairwise")
confint(contrast(emmeans(lmm, ~ stimulus), "pairwise"))
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(lmm, ~ manipulation|block)
contrast(emmeans(lmm, ~ manipulation|block), "revpairwise")
confint(contrast(emmeans(lmm, ~ manipulation|block), "revpairwise"))
emm <- emmeans(lmm, ~ block * manipulation)
emmip(emm, ~  block * manipulation, linearg = list(linetype = "blank"), CI = TRUE) +
  theme_bw() + labs(x = "task block", y = "Estimated Marginal Means")
```

### Post-hoc: bef.for. vs. bef.rev.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "forward.before vs reverse.before" = c(1, -1, 0, 0)), infer = T)
```

### Post-hoc: bef.for. vs. aft.for
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "forward.before vs forward.after" = c(1, 0, -1, 0)), infer = T)
```

### Post-hoc: bef.for. vs. aft.rev.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "forward.before vs reverse.after" = c(1, 0, 0, -1)), infer = T)
```

## BPS
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd_low ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm) 
r2_nakagawa(lmm) 
```

### Post-hoc: age
```{r, warning=FALSE}
emtrends(lmm, ~ age, var = "age")
```

### Post-hoc: manipulation x group
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|group), method = "revpairwise")
confint(contrast(emmeans(lmm, ~ manipulation|group), method = "revpairwise"))
emmip(lmm, ~ manipulation | group, linearg = list(linetype = "blank"), CIs = T)
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|block), "revpairwise")
confint(contrast(emmeans(lmm, ~ manipulation|block), "revpairwise"))
```

### Post-hoc: bef.rev. vs. aft.for.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs forward.after" = c(0, -1, 1, 0)), infer = T)
```

### Post-hoc: bef.rev. vs. aft.rev.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs reverse.after" = c(0, -1, 0, 1)), infer = T)
emmip(emm, ~  block * manipulation, linearg = list(linetype = "blank"), CI = TRUE) +
  theme_bw() + labs(x = "task block", y = "Estimated Marginal Means")
```

## MMN Amplitude
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: stimulus
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ stimulus), "pairwise")
confint(contrast(emmeans(lmm, ~ stimulus), "pairwise"))
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|block), "revpairwise")
confint(contrast(emmeans(lmm, ~ manipulation|block), "revpairwise"))
emm <- emmeans(lmm, ~ block * manipulation)

plot_data <- as.data.frame(emmeans(lmm, ~ block * manipulation))
plot_data <- na.omit(plot_data)
interaction_plot_MMN <- ggplot(plot_data, aes(x = manipulation, y = emmean, group = block, color = block, fill = block)) +
  geom_crossbar(aes(ymin = emmean - 1 * SE, ymax = emmean + 1 * SE), 
                alpha = 0.8, 
                position = position_dodge(width = 0.7),  
                width = 0.3) +  
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), 
                position = position_dodge(width = 0.7), 
                width = 0.2) +  
  scale_color_manual(values = c("blue", "orange")) +  
  scale_fill_manual(values = c("blue", "orange")) +   
  theme_bw() +
  labs(title = "Manipulation x block interaction on MMN amplitude",
       x = "Manipulation",
       y = "z_MMN_amplitude (emm)") +
  theme(plot.title = element_text(face = "bold"))
print(interaction_plot_MMN)
```

### Post-hoc: bef.rev vs. aft.for
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs forward.after" = c(0, -1, 1, 0)), infer = T)
```

### Post-hoc: bef.rev. vs. aft.rev.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs reverse.after" = c(0, -1, 0, 1)), infer = T)
```

## MMN Latency
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_latency ~ stimulus * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: age
```{r, warning=FALSE}
emtrends(lmm, ~ age, var = "age")
```

## MMN Diff Amplitude
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_diff_amplitude ~  manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = MMN_diff)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: age
```{r, warning=FALSE}
emtrends(lmm, ~ age, var = "age")
```

## MMN Diff Latency
### Main Model
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_diff_latency ~  manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = MMN_diff)
anova(lmm)
r2_nakagawa(lmm)
```

## P3a Amplitude
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ stimulus * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: age
```{r, warning=FALSE}
emtrends(lmm, ~ age, var = "age")
```

### Post-hoc: stimulus x group x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ stimulus * block|group), "pairwise") # -> MHC: stimulus effect in reverse blocks
confint(contrast(emmeans(lmm, ~ stimulus * block|group), "pairwise"))
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(lmm, ~ manipulation|block)
contrast(emmeans(lmm, ~ manipulation|block), "revpairwise")
# confint(contrast(emmeans(lmm, ~ manipulation|block), "revpairwise"))
emm <- emmeans(lmm, ~ block * manipulation)

plot_data <- as.data.frame(emmeans(lmm, ~ block * manipulation))
plot_data <- na.omit(plot_data)
interaction_plot_P3a <- ggplot(plot_data, aes(x = manipulation, y = emmean, group = block, color = block, fill = block)) +
  geom_crossbar(aes(ymin = emmean - 1 * SE, ymax = emmean + 1 * SE), 
                alpha = 0.8, 
                position = position_dodge(width = 0.7),  
                width = 0.3) +  
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), 
                position = position_dodge(width = 0.7), 
                width = 0.2) +  
  scale_color_manual(values = c("blue", "orange")) +  
  scale_fill_manual(values = c("blue", "orange")) +   
  theme_bw() +
  labs(title = "Manipulation x block interaction on P3a amplitude",
       x = "Manipulation",
       y = "z_P3a_amplitude (emm)") +
  theme(plot.title = element_text(face = "bold"))
print(interaction_plot_P3a)
```

### Post-hoc: bef.rev. vs. aft.for.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs forward.after" = c(0, -1, 1, 0)), infer = T)
```

### Post-hoc: bef.rev. vs. aft.rev.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs reverse.after" = c(0, 1, 0, -1)), infer = T)
```

## P3a Latency
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_latency ~ stimulus * manipulation * group * block + (1|SEGA_ID) + gender + age,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: stimulus
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ stimulus), "pairwise")
confint(contrast(emmeans(lmm, ~ stimulus), "pairwise"))
```

## Associations of the pupillometric indices
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ z_rpd_low * stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: BPS
```{r, warning=FALSE}
emtrends(lmm, ~ z_rpd_low, var = "z_rpd_low")
summary(emtrends(lmm, ~ z_rpd_low, var = "z_rpd_low"), infer = T)
```

### Post-hoc: BPS x group
```{r, warning=FALSE}
emt <- emtrends(lmm, ~ group, var = "z_rpd_low")
contrast(emtrends(lmm, ~ group, var = "z_rpd_low"))
confint(contrast(emt))
contrast(emt, "pairwise")
```

## Association between pupillometric indices and ERPs
### Does SEPR/BPS predict MMN amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ z_rpd * z_rpd_low * stimulus *  manipulation * group + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

#### Post-hoc: SEPR x BPS x stimulus
```{r, warning=FALSE}
emtrends(lmm, ~ z_rpd_low * z_rpd | stimulus, var = 'z_rpd', at = list(z_rpd_low = c(-2,-1,0,1,2)))
summary(emt, infer = T)
```

### Does SEPR/BPS predict P3a amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ z_rpd * z_rpd_low * stimulus *  manipulation * group + (1|SEGA_ID) + age + gender,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

#### Post-hoc: BPS x stimulus x group
```{r, warning=FALSE}
emtrends(lmm, ~ z_rpd_low * stimulus * group, var = 'z_rpd_low')
contrast(emtrends(lmm, ~ z_rpd_low * stimulus * group, var = 'z_rpd_low'))
confint(contrast(emtrends(lmm, ~ z_rpd_low * stimulus * group, var = 'z_rpd_low')))
```

#### Post-hoc: SEPR x stimulus x manipulation x group
```{r, warning=FALSE}
emtrends(lmm, ~ z_rpd  * manipulation | group * stimulus, var = 'z_rpd')
contrast(emtrends(lmm, ~ z_rpd  * manipulation | group * stimulus, var = 'z_rpd'))
```

# **Trial Level**
## Distributions of dependent variables
```{r, warning=FALSE}
par(mfrow = c(2,2), mar = c(4, 4, 2, 1))
hist(et_erp_trial$z_rpd,
     main = "Distribution of rpd (500-1500 ms)",
     xlab = "rpd",
     breaks = 200)
hist(et_erp_trial$z_rpd_low,
     main = "Distribution of rpd_low (0-250 ms)",
     xlab = "rpd_low",
     xlim = c(-4, 6),
     breaks = 200)
hist(et_erp_trial$z_MMN_amplitude,
     main = "Distribution of MMN amplitude (100-150 ms)",
     xlab = "MMN amplitude (FC1, FC2, FCz, Fz)",
     xlim = c(-6, 6),
     breaks = 200)
hist(et_erp_trial$z_P3a_amplitude,
     main = "Distribution of P3a amplitude (150-250 ms)",
     xlab = "P3a amplitude (Cz, FCz)",
     breaks = 200)
par(mfrow = c(1,1))
```

## SEPR
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: stimulus
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ stimulus), "pairwise")
confint(contrast(emmeans(lmm, ~ stimulus), "pairwise"))
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
emmeans(lmm, ~ manipulation|block)
contrast(emmeans(lmm, ~ manipulation|block), "revpairwise")
confint(contrast(emmeans(lmm, ~ manipulation|block), "revpairwise"))
emm <- emmeans(lmm, ~ block * manipulation)
emmip(emm, ~  block * manipulation, linearg = list(linetype = "blank"), CI = TRUE) +
  theme_bw() + labs(x = "task block", y = "Estimated Marginal Means")
```

### Post-hoc: bef.for. vs. bef.rev.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "forward.before vs reverse.before" = c(1, -1, 0, 0)), infer = T)
```

### Post-hoc: bef.for. vs. aft.for
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "forward.before vs forward.after" = c(1, 0, -1, 0)), infer = T)
```

### Post-hoc: bef.for. vs. aft.rev.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "forward.before vs reverse.after" = c(1, 0, 0, -1)), infer = T)
```

## BPS
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd_low ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: age
```{r, warning=FALSE}
emtrends(lmm, ~ age, var = "age")
```

### Post-hoc: manipulation x group
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|group), "revpairwise")
confint(contrast(emmeans(lmm, ~ manipulation|group), "revpairwise"))
```

### Post-hoc: block x group
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|group), "revpairwise")
confint(contrast(emmeans(lmm, ~ manipulation|group), "revpairwise"))
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|block), "revpairwise")
confint(contrast(emmeans(lmm, ~ manipulation|block), "revpairwise"))
```

### Post-hoc: bef.rev. vs. aft.for.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs forward.after" = c(0, 1, -1, 0)), infer = T)
```

### Post-hoc: bef.rev. vs. aft.rev.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs reverse.after" = c(0, 1, 0, -1)), infer = T)
```

## MMN Amplitude
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: stimulus
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ stimulus), "pairwise")
confint(contrast(emmeans(lmm, ~ stimulus), "pairwise"))
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ block|manipulation), "pairwise")
emm <- emmeans(lmm, ~ block * manipulation)
emmip(emm, ~  block * manipulation, linearg = list(linetype = "blank"), CI = TRUE) +
  theme_bw() + labs(x = "task block", y = "Estimated Marginal Means")
```

### Post-hoc: bef.rev. vs. aft.for.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs forward.after" = c(0, 1, -1, 0)), infer = T)
```

### Post-hoc: bef.rev. vs. aft.rev.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs reverse.after" = c(0, 1, 0, -1)), infer = T)
```

## MMN Latency
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_latency ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: age
```{r, warning=FALSE}
emtrends(lmm, ~ age, var = "age")
```

### Post-hoc: stimulus
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ stimulus), "pairwise")
confint(contrast(emmeans(lmm, ~ stimulus), "pairwise"))
emmip(lmm, ~ stimulus, linearg = list(linetype = "blank"), CIs = T)
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|block), "revpairwise")
confint(contrast(emmeans(lmm, ~ manipulation|block), "revpairwise"))
emm <- emmeans(lmm, ~ block * manipulation)
emmip(emm, ~  block * manipulation, linearg = list(linetype = "blank"), CI = TRUE) +
  theme_bw() + labs(x = "task block", y = "Estimated Marginal Means")

plot_data <- as.data.frame(emmeans(lmm, ~ block * manipulation))
plot_data <- na.omit(plot_data)

interaction_plot_MNN_latency <- ggplot(plot_data, aes(x = manipulation, y = emmean, group = block, color = block)) +
  geom_crossbar(aes(ymin = emmean - 1 * SE, ymax = emmean + 1 * SE), 
                alpha = 0.8, 
                position = position_dodge(width = 0.7),  
                width = 0.3) +  
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), 
                position = position_dodge(width = 0.7), 
                width = 0.2) +  
  scale_color_manual(values = c("blue", "orange")) +  
  scale_fill_manual(values = c("blue", "orange")) +   
  theme_bw() +
  labs(title = "Manipulation x block interaction on MMN latency",
       x = "Manipulation",
       y = "MMN latency [z]") +
  theme(plot.title = element_text(face = "bold"), legend.position = "none")
print(interaction_plot_MNN_latency)
```
 
### Post-hoc: bef.rev. vs. aft.for.
```{r, warning=FALSE}
emm <- emmeans(lmm, ~ block * manipulation)
contrast(emm, method = list(
  "reverse.before vs forward.after" = c(0, -1, 1, 0)), infer = T)
emmip(emm, ~  block * manipulation, linearg = list(linetype = "blank"), CI = TRUE) +
  theme_bw() + labs(x = "task block", y = "Estimated Marginal Means")
```

## P3a Amplitude
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: age
```{r, warning=FALSE}
emtrends(lmm, ~ age, var = "age")
```

### Post-hoc: gender
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ gender), "pairwise")
confint(contrast(emmeans(lmm, ~ gender), "pairwise"))
emmip(lmm, ~ gender, linearg = list(linetype = "blank"), CI = T)
```

### Post-hoc: manipulation x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ manipulation|block), "pairwise")
confint(contrast(emmeans(lmm, ~ manipulation|block), "pairwise"))
```

### Post-hoc: bef.rev. vs. aft.for.
```{r, warning=FALSE}
contrast(emm, method = list(
  "reverse.before vs forward.after" = c(0, 1, -1, 0)), infer = T)
```

### Post-hoc: bef.rev. vs. aft.rev.
```{r, warning=FALSE}
contrast(emm, method = list(
  "reverse.before vs reverse.after" = c(0, 1, 0, -1)), infer = T)
```

### post-hoc: stimulus x group x block
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ stimulus * block|group), "pairwise")
confint(contrast(emmeans(lmm, ~ stimulus * block|group), "pairwise"))
```

## P3a Latency
### Main model
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_latency ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: stimulus
```{r, warning=FALSE}
contrast(emmeans(lmm, ~ stimulus), "pairwise")
confint(contrast(emmeans(lmm, ~ stimulus), "pairwise"))
```
 
## Associations of the pupillometric indices
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ z_rpd_low * stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm) 
```

### Post-hoc: BPS
```{r, warning=FALSE}
emtrends(lmm, ~ z_rpd_low, var = "z_rpd_low")
summary(emtrends(lmm, ~ z_rpd_low, var = "z_rpd_low"), infer = T)
```

### Post-hoc: BPS x manipulation x block
```{r, warning=FALSE}
emt <- emtrends(lmm, ~ manipulation|block, var = "z_rpd_low")
contrast(emt, "revpairwise")
confint(contrast(emt, "revpairwise"))
```

### Post-hoc: BPS x manipulation x group
```{r, warning=FALSE}
emt <- emtrends(lmm, ~ manipulation|group, var = "z_rpd_low")
contrast(emt, "revpairwise")
confint(contrast(emt, "revpairwise"))
```

## Association between pupillometric indices and ERPs
### Does SEPR/BPS predict MMN amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ z_rpd * z_rpd_low * stimulus *  manipulation * group + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

### Post-hoc: BPS
```{r, warning=FALSE}
emt <- emtrends(lmm, ~ z_rpd_low, var = "z_rpd_low")
summary(emt, infer = T)
```

### Post-hoc: SEPR
```{r, warning=FALSE}
emt <- emtrends(lmm, ~ z_rpd, var = "z_rpd")
summary(emt, infer = T)
```

### Post-hoc: BPS x SEPR x group
```{r, warning=FALSE}
emt <- emtrends(lmm, ~  z_rpd * z_rpd_low|group,  var = 'z_rpd', at = list(z_rpd_low = c(-2,2)))
contrast(emt)
confint(contrast(emt))
```

### Does SEPR/BPS predict P3a amplitude?
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ z_rpd * z_rpd_low * stimulus *  manipulation * group + (1|SEGA_ID) + age + gender,
  data = et_erp_trial)
anova(lmm)
r2_nakagawa(lmm)
```

#### Post-hoc: SEPR
```{r, warning=FALSE}
emt <- emtrends(lmm, ~ z_rpd, var = "z_rpd")
summary(emt, infer = T)
```

#### Post-hoc: BPS x group
```{r, warning=FALSE}
emt <- emtrends(lmm, ~ group, var = c("z_rpd_low"))
contrast(emt)
```

# **Exploratory Analyses**
## Covariate IQ
### MMN amplitude
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender + verbal_IQ + non_verbal_IQ,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### MMN latency
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_latency ~ stimulus * manipulation * group * block + (1|SEGA_ID) + gender + age + verbal_IQ + non_verbal_IQ,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### MMN diff amplitude
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_diff_amplitude ~  manipulation * group * block + (1|SEGA_ID) + gender + age + verbal_IQ + non_verbal_IQ,
  data = MMN_diff)
anova(lmm)
r2_nakagawa(lmm)
```

### MMN diff latency
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_diff_latency ~  manipulation * group * block + (1|SEGA_ID) + gender + age + verbal_IQ + non_verbal_IQ,
  data = MMN_diff)
anova(lmm)
r2_nakagawa(lmm)
```

### P3a amplitude
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ stimulus * manipulation * group * block + (1|SEGA_ID) + gender + age + verbal_IQ + non_verbal_IQ,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### P3a latency
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_latency ~ stimulus * manipulation * group * block + (1|SEGA_ID) + gender + age + verbal_IQ + non_verbal_IQ,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm) 
```

### SEPR
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender + verbal_IQ + non_verbal_IQ,
  data = et_erp_subject)
anova(lmm)
r2_nakagawa(lmm)
```

### BPS
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd_low ~ stimulus * manipulation * group * block + (1|SEGA_ID) + age + gender + verbal_IQ + non_verbal_IQ,
  data = et_erp_subject)
anova(lmm) 
r2_nakagawa(lmm) 
```

## Grip strength
### MMN amplitude
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_amplitude ~ stimulus * group * block * z_grip_strength + (1|SEGA_ID) + age + gender,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm)
```

### MMN latency
```{r, warning=FALSE}
lmm <- lmer(
  z_MMN_latency ~ stimulus * group * block * z_grip_strength+ (1|SEGA_ID) + age + gender,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm)
```

### P3a amplitude
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_amplitude ~ stimulus * group * block * z_grip_strength + (1|SEGA_ID) + age + gender,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm) 
```

### P3a latency
```{r, warning=FALSE}
lmm <- lmer(
  z_P3a_latency ~ stimulus * group * block * z_grip_strength+ (1|SEGA_ID) + age + gender,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm) 
```

### SEPR
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd ~ stimulus * group * block * z_grip_strength + (1|SEGA_ID) + age + gender,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm)
r2_nakagawa(lmm) 
```

### BPS
```{r, warning=FALSE}
lmm <- lmer(
  z_rpd_low ~ stimulus * group * block * z_grip_strength + (1|SEGA_ID) + age + gender,
  data = et_erp_subject[et_erp_subject$manipulation == "after", ])
anova(lmm) 
r2_nakagawa(lmm)
```

#### Post-hoc: grip strength
```{r, warning=FALSE}
emtrends(lmm, ~ z_grip_strength, var = "z_grip_strength")
summary(emtrends(lmm, ~ z_grip_strength, var = "z_grip_strength"), infer = T)
```

#### Post-hoc: group x grip_strength
```{r, warning=FALSE}
emt <- emtrends(lmm, ~ group, var = 'z_grip_strength')
contrast(emt)
confint(contrast(emt))
```